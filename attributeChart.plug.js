var U=Object.defineProperty;var m=(e,r)=>{for(var n in r)U(e,n,{get:r[n],enumerable:!0})};var p=e=>{throw new Error("Not initialized yet")},b=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var h=new Map,P=0;b&&(globalThis.syscall=async(e,...r)=>await new Promise((n,i)=>{P++,h.set(P,{resolve:n,reject:i}),p({type:"sys",id:P,name:e,args:r})}));function T(e,r,n){b&&(p=n,self.addEventListener("message",i=>{(async()=>{let o=i.data;switch(o.type){case"inv":{let s=e[o.name];if(!s)throw new Error(`Function not loaded: ${o.name}`);try{let c=await Promise.resolve(s(...o.args||[]));p({type:"invr",id:o.id,result:c})}catch(c){console.error("An exception was thrown as a result of invoking function",o.name,"error:",c.message),p({type:"invr",id:o.id,error:c.message})}}break;case"sysr":{let s=o.id,c=h.get(s);if(!c)throw Error("Invalid request id");h.delete(s),o.error?c.reject(new Error(o.error)):c.resolve(o.result)}break}})().catch(console.error)}),p({type:"manifest",manifest:r}))}function R(e){let r=atob(e),n=r.length,i=new Uint8Array(n);for(let o=0;o<n;o++)i[o]=r.charCodeAt(o);return i}function w(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let r="",n=e.byteLength;for(let i=0;i<n;i++)r+=String.fromCharCode(e[i]);return btoa(r)}async function q(e,r){if(typeof e!="string"){let n=new Uint8Array(await e.arrayBuffer()),i=n.length>0?w(n):void 0;r={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:i},e=e.url}return syscall("sandboxFetch.fetch",e,r)}globalThis.nativeFetch=globalThis.fetch;function N(){globalThis.fetch=async function(e,r){let n=r&&r.body?w(new Uint8Array(await new Response(r.body).arrayBuffer())):void 0,i=await q(e,r&&{method:r.method,headers:r.headers,base64Body:n});return new Response(i.base64Body?R(i.base64Body):null,{status:i.status,headers:i.headers})}}b&&N();typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function t(e,...r){return globalThis.syscall(e,...r)}var g={};m(g,{deleteAttachment:()=>H,deleteFile:()=>X,deletePage:()=>D,fileExists:()=>Z,getAttachmentMeta:()=>I,getFileMeta:()=>z,getPageMeta:()=>O,listAttachments:()=>$,listFiles:()=>G,listPages:()=>L,listPlugs:()=>j,readAttachment:()=>_,readFile:()=>J,readPage:()=>Q,writeAttachment:()=>V,writeFile:()=>Y,writePage:()=>K});function L(){return t("space.listPages")}function O(e){return t("space.getPageMeta",e)}function Q(e){return t("space.readPage",e)}function K(e,r){return t("space.writePage",e,r)}function D(e){return t("space.deletePage",e)}function j(){return t("space.listPlugs")}function $(){return t("space.listAttachments")}function I(e){return t("space.getAttachmentMeta",e)}function _(e){return t("space.readAttachment",e)}function V(e,r){return t("space.writeAttachment",e,r)}function H(e){return t("space.deleteAttachment",e)}function G(){return t("space.listFiles")}function J(e){return t("space.readFile",e)}function z(e){return t("space.getFileMeta",e)}function Y(e,r){return t("space.writeFile",e,r)}function X(e){return t("space.deleteFile",e)}function Z(e){return t("space.fileExists",e)}var d={};m(d,{applyAttributeExtractors:()=>ie,getEnv:()=>ue,getMode:()=>le,getSpaceConfig:()=>se,getVersion:()=>pe,invokeCommand:()=>re,invokeFunction:()=>ee,invokeSpaceFunction:()=>oe,listCommands:()=>te,listSyscalls:()=>ne,reloadConfig:()=>ce,reloadPlugs:()=>ae});function ee(e,...r){return t("system.invokeFunction",e,...r)}function re(e,r){return t("system.invokeCommand",e,r)}function te(){return t("system.listCommands")}function ne(){return t("system.listSyscalls")}function oe(e,...r){return t("system.invokeSpaceFunction",e,...r)}function ie(e,r,n){return t("system.applyAttributeExtractors",e,r,n)}async function se(e,r){return await t("system.getSpaceConfig",e)??r}function ae(){return t("system.reloadPlugs")}function ce(){return t("system.reloadConfig")}function ue(){return t("system.getEnv")}function le(){return t("system.getMode")}function pe(){return t("system.getVersion")}var y={};m(y,{listLanguages:()=>ye,parseLanguage:()=>ge});function ge(e,r){return t("language.parseLanguage",e,r)}function ye(){return t("language.listLanguages")}var x={};m(x,{parse:()=>Te,stringify:()=>we});function Te(e){return t("yaml.parse",e)}function we(e){return t("yaml.stringify",e)}function Me(e,r){return C(e,n=>n.type===r)}function C(e,r){if(r(e))return[e];let n=[];if(e.children)for(let i of e.children)n=[...n,...C(i,r)];return n}function A(e){if(!e)return"";let r=[];if(e.text!==void 0)return e.text;for(let n of e.children)r.push(A(n));return r.join("")}function v(e,r=!0){if(Me(e,"\u26A0").length>0)throw new Error(`Parse error in: ${A(e)}`);if(e.text!==void 0)return e.text;let i=[e.type];for(let o of e.children)o.type&&!o.type.endsWith("Mark")&&o.type!=="Comment"&&i.push(v(o,r)),o.text&&(r&&o.text.trim()||!r)&&i.push(o.text);return i}function S(e){let r={querySource:""},[n,i,...o]=e;if(n!=="Query")throw new Error(`Expected query type, got ${n}`);r.querySource=i[1];for(let s of o){let[c]=s;switch(c){case"WhereClause":{r.filter?r.filter=["and",r.filter,a(s[2])]:r.filter=a(s[2]);break}case"OrderClause":{r.orderBy||(r.orderBy=[]);for(let u of s.slice(2))if(u[0]==="OrderBy"){let l=u[1][1];u[2]?r.orderBy.push({expr:a(l),desc:u[2][1][1]==="desc"}):r.orderBy.push({expr:a(l),desc:!1})}break}case"LimitClause":{r.limit=a(s[2][1]);break}case"SelectClause":{for(let u of s.slice(2))u[0]==="Select"&&(r.select||(r.select=[]),u.length===2?r.select.push({name:f(u[1][1])}):r.select.push({name:f(u[3][1]),expr:a(u[1])}));break}case"RenderClause":{let u=s.find(l=>l[0]==="PageRef");r.render=u[1].slice(2,-2),r.renderAll=!!s.find(l=>l[0]==="all");break}default:throw new Error(`Unknown clause type: ${c}`)}}return r}function f(e){return e.startsWith("`")&&e.endsWith("`")?e.slice(1,-1):e}function a(e){if(["LVal","Expression","Value"].includes(e[0]))return a(e[1]);switch(e[0]){case"Attribute":return["attr",a(e[1]),f(e[3][1])];case"Identifier":return["attr",f(e[1])];case"String":return["string",e[1].slice(1,-1)];case"Number":return["number",+e[1]];case"Bool":return["boolean",e[1][1]==="true"];case"null":return["null"];case"Regex":return["regexp",e[1].slice(1,-1),"i"];case"List":{let r=[];for(let n of e.slice(2))n[0]==="Expression"&&r.push(n);return["array",r.map(a)]}case"Object":{let r=[];for(let n of e.slice(2)){if(typeof n=="string")continue;let[i,o,s,c]=n;r.push([o[1].slice(1,-1),a(c)])}return["object",r]}case"BinExpression":{let r=a(e[1]),n=e[2][0]==="in"?"in":e[2].trim(),i=a(e[3]);return[n,r,i]}case"LogicalExpression":{let r=a(e[1]),n=e[2],i=a(e[3]);return[n[1],r,i]}case"ParenthesizedExpression":return a(e[2]);case"Call":{let r=f(e[1][1]),n=[];for(let i of e.slice(2))i[0]==="Expression"&&n.push(i);return["call",r,n.map(a)]}case"UnaryExpression":{if(e[1][0]==="not"||e[1][0]==="!")return["not",a(e[2])];if(e[1][0]==="-")return["-",a(e[2])];throw new Error(`Unknown unary expression: ${e[1][0]}`)}case"TopLevelVal":return["attr"];case"GlobalIdentifier":return["global",e[1].substring(1)];case"TernaryExpression":{let[r,n,i,o,s,c]=e;return["?",a(n),a(o),a(c)]}case"QueryExpression":return["query",S(e[2])];case"PageRef":return["pageref",e[1].slice(2,-2)];default:throw new Error(`Not supported: ${e[0]}`)}}async function E(e){let r=v(await y.parseLanguage("query",e));return S(r[1])}async function M(e,r){let n=await d.getSpaceConfig(),i=await g.readPage(r);try{let o=await x.parse(e),s=await E(o.query),c=o.attributes||[],u=o.options||{},l=await d.invokeFunction("query.renderQuery",s,{page:i,config:n});return{html:`
      <style>
        html[data-theme=dark] {
          color-scheme: dark;
          --root-background-color: #111;
          --root-color: #fff;
          --top-background-color: #262626;
        }
        html {
          --root-background-color: #fff;
          --root-color: inherit;
          --top-background-color: #e1e1e1;
          --ui-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"
        }
        body{
          margin:0;
          background-color:var(--root-background-color);
          color:var(--root-color);
          font-family: var(--ui-font);
        }
      </style>
      <canvas id="myChart"></canvas>`,script:`
        loadJsByUrl("https://cdn.jsdelivr.net/npm/chart.js").then(() => {
          const chartData = ${JSON.stringify(ke(l,c))};
          const ctx = document.getElementById('myChart');
          const myChart = new Chart(ctx, {
            data: chartData,
            options: ${JSON.stringify(u)}
          })
        });
      `}}catch(o){return{markdown:`**Error:** ${o.message}`}}}function ke(e,r=[]){let n=e.map(o=>o.name.replace(/^.*\//,"")),i=[];for(let o of r)o.name&&i.push({type:o.type||"line",label:o.label||o.name,data:e.map(s=>s.attribute&&s.attribute[o.name]),...o.color&&{backgroundColor:o.color,borderColor:o.color}});return{labels:n,datasets:i}}var k={attributeChartWidget:M},F={name:"attributeChart",functions:{attributeChartWidget:{path:"attributeChart.ts:widget",codeWidget:"attributeChart"}},assets:{}},pr={manifest:F,functionMapping:k};T(k,F,self.postMessage);export{pr as plug};
