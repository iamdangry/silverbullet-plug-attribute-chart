var q=Object.defineProperty;var P=(e,t)=>{for(var r in t)q(e,r,{get:t[r],enumerable:!0})};var v=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var T=new Map,h=0;function m(e){self.postMessage(e)}v&&(globalThis.syscall=async(e,...t)=>await new Promise((r,n)=>{h++,T.set(h,{resolve:r,reject:n}),m({type:"sys",id:h,name:e,args:t})}));function S(e,t){v&&(self.addEventListener("message",r=>{(async()=>{let n=r.data;switch(n.type){case"inv":{let o=e[n.name];if(!o)throw new Error(`Function not loaded: ${n.name}`);try{let s=await Promise.resolve(o(...n.args||[]));m({type:"invr",id:n.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",n.name,"error:",s.message),m({type:"invr",id:n.id,error:s.message})}}break;case"sysr":{let o=n.id,s=T.get(o);if(!s)throw Error("Invalid request id");T.delete(o),n.error?s.reject(new Error(n.error)):s.resolve(n.result)}break}})().catch(console.error)}),m({type:"manifest",manifest:t}))}function L(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let o=0;o<r;o++)n[o]=t.charCodeAt(o);return n}function A(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",r=e.byteLength;for(let n=0;n<r;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function B(e,t){if(typeof e!="string"){let r=new Uint8Array(await e.arrayBuffer()),n=r.length>0?A(r):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:n},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function V(){globalThis.fetch=async function(e,t){let r=t&&t.body?A(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,n=await B(e,t&&{method:t.method,headers:t.headers,base64Body:r});return new Response(n.base64Body?L(n.base64Body):null,{status:n.status,headers:n.headers})}}v&&V();typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function i(e,...t){return globalThis.syscall(e,...t)}var l={};P(l,{applyAttributeExtractors:()=>_,getEnv:()=>z,getMode:()=>G,getSpaceConfig:()=>J,getVersion:()=>Z,invokeCommand:()=>N,invokeFunction:()=>Q,invokeSpaceFunction:()=>$,listCommands:()=>W,listSyscalls:()=>I,reloadConfig:()=>H,reloadPlugs:()=>Y});function Q(e,...t){return i("system.invokeFunction",e,...t)}function N(e,t){return i("system.invokeCommand",e,t)}function W(){return i("system.listCommands")}function I(){return i("system.listSyscalls")}function $(e,...t){return i("system.invokeSpaceFunction",e,...t)}function _(e,t,r){return i("system.applyAttributeExtractors",e,t,r)}async function J(e,t){return await i("system.getSpaceConfig",e)??t}function Y(){return i("system.reloadPlugs")}function H(){return i("system.reloadConfig")}function z(){return i("system.getEnv")}function G(){return i("system.getMode")}function Z(){return i("system.getVersion")}var g={};P(g,{listLanguages:()=>ne,parseLanguage:()=>re});function re(e,t){return i("language.parseLanguage",e,t)}function ne(){return i("language.listLanguages")}var p={};P(p,{parse:()=>ce,stringify:()=>ue});function ce(e){return i("yaml.parse",e)}function ue(e){return i("yaml.stringify",e)}function de(e,t){return F(e,r=>r.type===t)}function F(e,t){if(t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...F(n,t)];return r}function y(e){if(!e)return"";let t=[];if(e.text!==void 0)return e.text;for(let r of e.children)t.push(y(r));return t.join("")}function w(e,t=!0){if(de(e,"\u26A0").length>0)throw new Error(`Parse error in: ${y(e)}`);if(e.text!==void 0)return e.text;let n=[e.type];for(let o of e.children)o.type&&!o.type.endsWith("Mark")&&n.push(w(o,t)),o.text&&(t&&o.text.trim()||!t)&&n.push(o.text);return n}function O(e){let t={querySource:""},[r,n,...o]=e;if(r!=="Query")throw new Error(`Expected query type, got ${r}`);t.querySource=n[1];for(let s of o){let[u]=s;switch(u){case"WhereClause":{t.filter?t.filter=["and",t.filter,a(s[2])]:t.filter=a(s[2]);break}case"OrderClause":{t.orderBy||(t.orderBy=[]);for(let c of s.slice(2))if(c[0]==="OrderBy"){let f=c[1][1];c[2]?t.orderBy.push({expr:a(f),desc:c[2][1][1]==="desc"}):t.orderBy.push({expr:a(f),desc:!1})}break}case"LimitClause":{t.limit=a(s[2][1]);break}case"SelectClause":{for(let c of s.slice(2))c[0]==="Select"&&(t.select||(t.select=[]),c.length===2?t.select.push({name:d(c[1][1])}):t.select.push({name:d(c[3][1]),expr:a(c[1])}));break}case"RenderClause":{let c=s.find(f=>f[0]==="PageRef");t.render=c[1].slice(2,-2),t.renderAll=!!s.find(f=>f[0]==="all");break}default:throw new Error(`Unknown clause type: ${u}`)}}return t}function d(e){return e.startsWith("`")&&e.endsWith("`")?e.slice(1,-1):e}function a(e){if(["LVal","Expression","Value"].includes(e[0]))return a(e[1]);switch(e[0]){case"Attribute":return["attr",a(e[1]),d(e[3][1])];case"Identifier":return["attr",d(e[1])];case"String":return["string",e[1].slice(1,-1)];case"Number":return["number",+e[1]];case"Bool":return["boolean",e[1][1]==="true"];case"null":return["null"];case"Regex":return["regexp",e[1].slice(1,-1),"i"];case"List":{let t=[];for(let r of e.slice(2))r[0]==="Expression"&&t.push(r);return["array",t.map(a)]}case"Object":{let t=[];for(let r of e.slice(2)){if(typeof r=="string")continue;let[n,o,s,u]=r;t.push([o[1].slice(1,-1),a(u)])}return["object",t]}case"BinExpression":{let t=a(e[1]),r=e[2][0]==="InKW"?"in":e[2].trim(),n=a(e[3]);return[r,t,n]}case"LogicalExpression":{let t=a(e[1]),r=e[2],n=a(e[3]);return[r[1],t,n]}case"ParenthesizedExpression":return a(e[2]);case"Call":{let t=d(e[1][1]),r=[];for(let n of e.slice(2))n[0]==="Expression"&&r.push(n);return["call",t,r.map(a)]}case"UnaryExpression":{if(e[1][0]==="NotKW"||e[1][0]==="!")return["not",a(e[2])];if(e[1][0]==="-")return["-",a(e[2])];throw new Error(`Unknown unary expression: ${e[1][0]}`)}case"TopLevelVal":return["attr"];case"GlobalIdentifier":return["global",e[1].substring(1)];case"TernaryExpression":{let[t,r,n,o,s,u]=e;return["?",a(r),a(o),a(u)]}case"QueryExpression":return["query",O(e[2])];case"PageRef":return["pageref",e[1].slice(2,-2)];default:throw new Error(`Not supported: ${e[0]}`)}}async function E(e){let t=w(await g.parseLanguage("query",e));return O(t[1])}var x=class{constructor(t,r={}){this.maxSize=t;this.map=new Map(Object.entries(r))}map;set(t,r,n){let o={value:r,la:Date.now()};if(n){let s=this.map.get(t);s?.expTimer&&clearTimeout(s.expTimer),o.expTimer=setTimeout(()=>{this.map.delete(t)},n)}if(this.map.size>=this.maxSize){let s=this.getOldestKey();this.map.delete(s)}this.map.set(t,o)}get(t){let r=this.map.get(t);if(r)return r.la=Date.now(),r.value}remove(t){this.map.delete(t)}toJSON(){return Object.fromEntries(this.map.entries())}getOldestKey(){let t,r;for(let[n,o]of this.map.entries())(!r||o.la<r)&&(t=n,r=o.la);return t}};var _e=new x(50);function K(e,t,r){return l.invokeFunction("index.getObjectByRef",e,t,r)}async function R(e){return e?await K(e,"page",e)||{ref:e,name:e,tags:["page"],lastModified:"",created:""}:{ref:"",name:"",tags:["page"],lastModified:"",created:""}}async function U(e,t){let r=await l.getSpaceConfig(),n=await R(t);try{let o=await p.parse(e),s=await E(o.query),u=o.attributes||{},c=await l.invokeFunction("query.renderQuery",s,{page:n,config:r});return{html:`
      <style>
        html[data-theme=dark] {
          color-scheme: dark;
          --root-background-color: #111;
          --root-color: #fff;
          --top-background-color: #262626;
        }
        html {
          --root-background-color: #fff;
          --root-color: inherit;
          --top-background-color: #e1e1e1;
          --ui-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"
        }
        body{
          margin:0;
          background-color:var(--root-background-color);
          color:var(--root-color);
          font-family: var(--ui-font);
        }
      </style>
      <canvas id="myChart"></canvas>`,script:`
        loadJsByUrl("https://cdn.jsdelivr.net/npm/chart.js").then(() => {
          const chartData = ${JSON.stringify(me(c,u))};
          console.log(${JSON.stringify({results:c,attributes:u})}, chartData);
          const ctx = document.getElementById('myChart');
          const myChart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          })
        });
      `}}catch(o){return{markdown:`**Error:** ${o.message}`}}}function me(e,t={}){let r=e.map(o=>o.name.replace("Journal/Day/","")),n=[];for(let o of Object.values(t))o.name&&n.push({type:o.type||"line",label:o.name,data:e.map(s=>s.attribute[o.name])});return{labels:r,datasets:n}}var j={attributeChartWidget:U},D={name:"attributeChart",functions:{attributeChartWidget:{path:"attributeChart.ts:widget",codeWidget:"attributeChart"}},assets:{}},St={manifest:D,functionMapping:j};S(j,D);export{St as plug};
